# Binance BTC Grid Strategy (Regime-Adaptive v2.0)

这是一个基于市场状态（Market Regime）自适应的高级比特币网格交易系统。相比传统网格，它通过多指标投票系统和动态风险控制机制，在震荡市中捕获套利收益，并在趋势市（特别是单边大跌）中自动防御。

## 📈 实战表现 (最近 30 天回测)
在 BTC 价格从 **$91,269 暴跌至 $67,022 (-26.57%)** 的极端空头背景下：
*   **总盈亏 (Total PnL)**: **+0.07%** (成功保本并微利)
*   **策略贡献 (Active PnL)**: **+13.34%** (策略通过震荡捕捉产生的净利润)
*   **最大回撤 (Max DD)**: **0.06%** (极度稳健的防御表现)

---

## 📊 策略架构 (v2.0)

### 1. 市场状态过滤器 (Regime Filter)
采用 **五指标投票系统** 来区分「震荡范围 (RANGE)」与「单边趋势 (TREND)」：
*   **Hurst Exponent**: 衡量序列的长期记忆性（均值回归属性）。
*   **ADX (Average Directional Index)**: 衡量趋势强度。
*   **ATR Ratio**: 短期/长期波动率比值，捕捉波动膨胀启动点。
*   **BB Width**: 布林带相对带宽，衡量挤压与突破。
*   **MA200 Slope**: 长期均线斜率，提供宏观趋势背景（第 5 票）。

### 2. 动态网格引擎 (Grid Engine)
*   **中轴漂移**: 以 MA20 作为网格中轴线，随行情动态平移。
*   **ATR 动态区间**: 网格宽度基于 $\text{ATR} \times \text{Multiplier}$ 计算。
*   **密度优化**: 默认通过 20 层密集下单捕获微小波动。

### 3. 三大进阶防御机制 (精髓)
*   **偏置网格 (Biased Grid)**: 空头背景（Price < MA200）下，自动将买单资金比例从 0.5 降至 **0.2**。极大地减缓了下跌途中的接盘速度，保护现金流。
*   **卖单持久化 (Order Persistence)**: 网格重置时，不再盲目清空所有订单。**保留已成交买单对应的卖单扣子**。这解决了网格被行情带着跑、无法完成离场套利的通病。
*   **超买保护 (Overbought Guard)**: 当 Bias (MA20 偏离度) > 5% 且触碰 BB 2.5σ 上轨时，熔断所有买单，只出不进，防止高位接盘。

---

## ⚙️ 核心参数详解 (strategy.yaml)

### 1. 核心调节
| 参数 | 推荐值 | 说明 |
| :--- | :--- | :--- |
| `trend_vote_threshold` | 3 | 投票数 ≥ 此值则判为趋势，停止网格 (范围 1-5) |
| `grid_reset_drift_pct` | 0.03 | 价格偏离中轴 3% 才重置网格，增加网格韧性 |
| `atr_band_multiplier` | 2.5 | ATR 乘数，越小网格越窄，捕获频率越高 |

### 2. 自动化防护
| 参数 | 默认值 | 说明 |
| :--- | :--- | :--- |
| `dynamic_usdt_ratio_enabled` | **true** | 空头跌势中自动降低买单权重 |
| `keep_persistent_orders` | **true** | 网格重置时保留已买入头寸的获利卖单 |
| `capital_below_ma_long` | 0.3 | 价格在 MA200 下方时的总资金利用率 (30%) |

---

## 🛠️ 使用指南

### 深度损益分析 (PnL Decomposition)
使用 `analyze_v2.py` 剥离“资产持仓波动”与“策略纯收益”：
```bash
python analyze_v2.py
```
*   **Passive PnL**: 底仓随价格走势产生的损益（如果为负，说明大盘在跌）。
*   **Active PnL**: 策略通过高抛低吸贡献的净利润（核心观察指标）。

### 回测配置 (Backtest Settings)
在 `strategy.yaml` 的 `backtest` 部分，可以将 `initial_pos_ratio` 设为 **1.0**。
- **1.0**: 全仓 USDT 启动，回测结果能纯粹反映策略从 0 开始的捕获能力。
- **0.5**: 模拟持有 50% 现货底仓的运行情况。

---

## ⚠️ 风险提示
本策略在单边崩盘行情中通过“降容”和“偏置”极大程度锁住了回撤，但在完全不反弹的垂直下跌中仍可能产生被动持仓。请根据本金规模合理设置 `min_order_value`（建议 > 5 USDT）。
