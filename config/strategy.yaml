# =============================================================
# strategy.yaml — 策略参数配置文件 (v2.0)
#
# 修改此文件即可调整策略行为，无需修改任何 Python 代码。
# 所有参数均有注释说明其含义和推荐调参方向。
# =============================================================


# =============================================================
# 一、市场状态过滤器 (Regime Filter)
# 用于判断当前市场是"横盘震荡"还是"单边趋势"
# =============================================================

regime_filter:

  # -----------------------------------------------------------
  # ADX (Average Directional Index) — 趋势强度指标
  # ADX 越高代表趋势越强，与方向无关。
  # 策略逻辑：
  #   - ADX < 25 且 Hurst < 0.5 → 震荡模式，网格全速运行
  #   - ADX > 30 且 Hurst > 0.6 → 熔断暂停，停止新网格挂单
  # -----------------------------------------------------------
  adx_period: 14              # ADX 计算周期（标准值：14）
  adx_trend_threshold: 25.0   # 震荡/趋势分界线（推荐范围：20-30）
  adx_fuse_threshold: 30.0    # 熔断阈值：ADX 超过此值触发趋势保护（配合 hurst_fuse_threshold）

  # -----------------------------------------------------------
  # ATR (Average True Range) — 波动率指标
  # 短期 ATR 相对长期 ATR 突然放大，通常是趋势启动的信号。
  # 同时用于动态网格区间计算（见 grid_engine 部分）。
  # -----------------------------------------------------------
  atr_short_period: 7         # 短期 ATR 周期
  atr_long_period: 28         # 长期 ATR 周期（建议为短期的 4 倍）
  atr_ratio_threshold: 1.5    # 短/长 ATR 比值超过此值视为趋势（推荐范围：1.3-2.0）

  # -----------------------------------------------------------
  # Bollinger Band Width — 布林带宽度
  # 带宽 = (上轨 - 下轨) / 中轨，衡量相对波动幅度。
  # 2.5 标准差版本用于超买/超卖判断（见 grid_engine.overbought_bb_std）。
  # -----------------------------------------------------------
  bb_period: 20               # 布林带计算周期（标准值：20）
  bb_std: 2.0                 # 布林带标准差倍数（标准值：2.0）
  bb_width_threshold: 0.1     # 相对带宽超过此值视为趋势（推荐范围：0.05-0.15）

  # -----------------------------------------------------------
  # Hurst Exponent — 长期记忆性指标（策略总开关核心）
  # H < 0.5: 均值回归（适合网格）
  # H ≈ 0.5: 随机游走（半仓运行）
  # H > 0.5: 趋势持续（不适合网格）
  # H > 0.6 + ADX > 30: 熔断，停止所有新挂单
  # H < 0.35: 极低均值回归，将网格利润部分转为现货积累 BTC
  # -----------------------------------------------------------
  hurst_period: 100           # 用于计算 Hurst 的历史数据点数（推荐范围：50-200）
  hurst_threshold: 0.5        # Hurst 超过此值视为趋势（通常固定为 0.5）
  hurst_fuse_threshold: 0.6   # 熔断阈值：Hurst 超过此值触发趋势保护（配合 adx_fuse_threshold）
  hurst_extreme_low: 0.35     # 极低阈值：低于此值时，将部分网格利润转为现货 BTC

  # -----------------------------------------------------------
  # 投票机制 — 综合判断阈值
  # 共 4 个指标参与投票，超过 trend_vote_threshold 个判断为趋势
  # 则最终输出 TREND，否则输出 RANGE。
  # 调参建议：
  #   - 设为 1 → 任意一个指标触发即暂停网格（最保守）
  #   - 设为 3 → 需要 3 个指标同时触发（最激进）
  #   - 推荐值：2（平衡敏感度与误报率）
  # -----------------------------------------------------------
  trend_vote_threshold: 2     # 判断为趋势所需的最少投票数（推荐范围：1-3）


# =============================================================
# 二、分级仓位响应 (Tiered Position Sizing)
# 基于 Hurst 指数动态调整网格资金利用率
# 注意：风控熔断（OI 激增、Hurst>0.6+ADX>30）的优先级高于分级响应
# =============================================================

position_sizing:

  # Hurst 分级响应表（从低到高）
  # 格式：[hurst_upper_bound, position_ratio]
  # 当 Hurst 落在某区间时，使用对应的仓位比例
  tiers:
    - hurst_max: 0.35   # H < 0.35：极低均值回归，转移部分利润为现货 BTC
      position_ratio: 1.00
      accumulate_spot: true   # 将网格利润部分转换为现货 BTC

    - hurst_max: 0.40   # 0.35 ≤ H < 0.40：强均值回归
      position_ratio: 1.00
      accumulate_spot: false

    - hurst_max: 0.50   # 0.40 ≤ H < 0.50：标准震荡
      position_ratio: 1.00
      accumulate_spot: false

    - hurst_max: 0.55   # 0.50 ≤ H < 0.55：接近随机游走，半仓
      position_ratio: 0.50
      accumulate_spot: false

    - hurst_max: 1.00   # H ≥ 0.55：趋势性，停止网格
      position_ratio: 0.00
      accumulate_spot: false

  # 风控熔断条件（优先级高于分级响应）
  fuse_conditions:
    oi_change_1h_threshold: 0.12    # OI 1小时增长超过 12% → 立即停止新挂单
    oi_change_24h_threshold: 0.12   # OI 24小时增长超过 12%（备用）
    hurst_adx_fuse: true            # 启用 Hurst > 0.6 且 ADX > 30 的联合熔断


# =============================================================
# 三、网格引擎参数 (Grid Engine)
# 基于 MA + 布林带 + ATR 动态设定网格区间
# =============================================================

grid_engine:

  # -----------------------------------------------------------
  # 基准线设定 (Moving Averages)
  # MA200: 大周期多空背景判断 → 决定资金利用率
  # MA20:  网格中轴线（动态漂移）
  # -----------------------------------------------------------
  ma_long_period: 200         # 大周期 MA，用于判断多空背景（可改为 120 或 60 提高灵敏度）
  ma_mid_period: 20           # 网格中轴线（MA20）

  # MA200 仓位分配策略
  # 价格 > MA200：看多背景，高资金利用率
  # 价格 < MA200：看空背景，低资金利用率
  capital_above_ma_long: 0.80   # 价格高于 MA200 时的网格资金利用率（80%）
  capital_below_ma_long: 0.30   # 价格低于 MA200 时的网格资金利用率（30%）

  # -----------------------------------------------------------
  # 动态网格区间 (ATR-based Boundaries)
  # 下限 = 当前价格 - atr_band_multiplier * ATR
  # 上限 = 当前价格 + atr_band_multiplier * ATR
  # -----------------------------------------------------------
  atr_band_multiplier: 3.0    # ATR 倍数，决定网格上下边界宽度（推荐范围：2.0-4.0）
  atr_period: 14              # 用于网格边界计算的 ATR 周期

  # -----------------------------------------------------------
  # 布林带超买/超卖保护 (Overbought/Oversold Guard)
  # 使用 2.5 标准差布林带 + MA20 偏离度（Bias）进行极端状态判断
  # 当价格触碰上轨 且 Bias > bias_overbought_threshold 时：
  #   → 停止买入格，只保留卖出格（防止高位接盘）
  # -----------------------------------------------------------
  overbought_bb_std: 2.5          # 超买判断使用的布林带标准差（比标准 2.0 更宽）
  overbought_bb_period: 20        # 超买布林带计算周期
  bias_overbought_threshold: 0.05 # MA20 偏离度阈值（5%），超过则视为极度超买
  # 当触发超买保护时：
  #   buy_grid_enabled: false（停止买入格）
  #   sell_grid_enabled: true（保留卖出格）

  # -----------------------------------------------------------
  # 网格步长与层级
  # -----------------------------------------------------------
  grid_levels: 10             # 网格层数（上下各 N 层）
  min_grid_spacing_pct: 0.003 # 最小网格间距（0.3%，防止过密）
  max_grid_spacing_pct: 0.05  # 最大网格间距（5%，防止过稀）
  min_order_qty: 0.0004       # 最小单笔下单量 (BTC)，需满足交易所最小名义价值要求


# =============================================================
# 四、风险控制参数 (Risk Control)
# =============================================================

risk_control:

  # 全局止损
  global_stop_loss_pct: 0.15    # 资产跌破初始资金 15% 时触发强制清仓

  # 资金费率保护（防止合约杠杆清算插针）
  funding_rate_max: 0.0004      # 资金费率单次超过 0.04% → 停止新挂单
  funding_rate_min: -0.0002     # 资金费率单次低于 -0.02% → 停止新挂单

  # CVD 背离保护
  cvd_divergence_enabled: true  # 启用 CVD 背离检测
  # CVD 创新高但价格未创新高 → 暂停买入格
  # CVD 创新低但价格未创新低 → 恢复买入格
