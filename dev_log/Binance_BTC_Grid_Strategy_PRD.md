# 产品需求文档 (PRD)：Binance BTC 自适应网格交易策略 (含 Regime Filter)

**版本:** 2.0  
**更新日期:** 2026-02-18  
**状态:** 更新中  
**目标:** 构建一个能够自动识别市场状态（震荡 vs 趋势），并在震荡行情中高效运行网格交易、在趋势行情中规避风险的量化系统。

---

## 1. 项目背景与目标
传统的网格交易策略在横盘震荡行情中表现优异，但在单边趋势（大涨或大跌）中极易产生大幅浮亏或卖空。本项目旨在引入 **市场状态过滤器 (Regime Filter)**，使策略能"自适应"地判断当前是否适合开启网格，从而提高夏普比率并降低最大回撤。

---

## 2. 核心算法逻辑

### 2.1 市场状态过滤器 (Regime Filter) — 策略总开关

用于判断当前市场是 **"横盘震荡"** 还是 **"单边趋势"**，以 **Hurst 指数** 和 **ADX** 作为核心双开关。

#### 指标组合

| 指标 | 计算方式 | 含义 |
|------|----------|------|
| **Hurst 指数** | R/S 分析法，窗口期 100 | H<0.5 均值回归；H>0.5 趋势持续 |
| **ADX** | 14 周期 | 趋势强度，与方向无关 |
| **ATR 比例** | 短期 ATR(7) / 长期 ATR(28) | 波动率突变检测 |
| **BB 宽度** | 20 周期，2.0σ | 相对波动幅度 |

#### 决策状态机

```
入场/运行条件（震荡模式）：
  Hurst < 0.5  AND  ADX < 25  →  Grid ON，按分级仓位运行

熔断暂停条件（趋势防护）：
  Hurst > 0.6  AND  ADX > 30  →  停止所有新网格挂单 / 收窄网格区间

风控熔断（优先级最高，高于分级响应）：
  OI 1h 增长 > 12%            →  立即停止新挂单
  资金费率 > 0.04% 或 < -0.02% →  停止新挂单（防杠杆清算插针）
  CVD 背离                    →  暂停买入格 / 恢复买入格
```

#### 图示参考
> 见 `dev_log/image.png` — 各指标触发阈值与策略动作对照表

---

### 2.2 分级仓位响应 (Tiered Position Sizing)

基于 Hurst 指数动态调整网格资金利用率，实现"越震荡越激进、越趋势越保守"的自适应效果。

| Hurst 区间 | 仓位比例 | 特殊动作 |
|-----------|---------|---------|
| H < 0.35  | 100%    | 将网格利润部分转换为**现货 BTC**，积累筹码（即将变盘信号）|
| 0.35 ≤ H < 0.50 | 100% | 正常网格运行 |
| H ≈ 0.50  | 50%     | 随机游走区间，半仓保守运行 |
| H > 0.55  | 0%      | 停止网格 |

> ⚠️ **风控熔断优先级高于分级响应**：即使 Hurst 处于 100% 仓位区间，若 OI 激增 12%，仍立即停止新挂单。

---

### 2.3 自适应网格引擎 (Adaptive Grid Engine)

#### 2.3.1 基准线与资金分配（MA 策略）

- **MA200（大周期）**：判断多空背景，决定资金利用率
  - 价格 > MA200：看多背景，网格资金利用率 **80%**
  - 价格 < MA200：看空背景，网格资金利用率 **30%**
  - > 注：MA200 不用于触发买卖，仅用于仓位分配。如追求灵敏度可改用 MA120（半年线）或 MA60（季度线）。

- **MA20（中轴线）**：网格的动态中轴，随价格缓慢漂移，确保网格始终覆盖当前价格区域。

#### 2.3.2 动态网格区间（ATR + 布林带）

```
网格下限 = 当前价格 - 3 × ATR(14)
网格上限 = 当前价格 + 3 × ATR(14)
```

- 波动率大（ATR 大）→ 网格区间自动变宽，获取更大波段利润
- 波动率小（ATR 小）→ 网格区间自动收窄，提高成交频率

#### 2.3.3 超买/超卖保护（布林带 2.5σ + MA 偏离度）

使用 **2.5 标准差布林带**（比标准 2.0σ 更宽）配合 **MA20 偏离度（Bias）** 进行极端状态判断：

```
触发条件：价格触碰布林带上轨  AND  Bias > 5%（相对 MA20）
策略动作：停止买入格，只保留卖出格
触发原因：价格处于极度超买状态，回调概率极大。停止买入是为了防止高位接盘，此时只卖不买，减仓避险。
```

---

## 3. 功能需求

### 3.1 交易执行模块
- **Binance API 对接:** 支持现货 (Spot) 或永续合约 (Futures)。
- **资产管理:** 初始资金分配、仓位精度控制（满足币安最小交易额限制）。
- **多级别挂单:** 支持等差数列或等比数列挂单。
- **单向保护模式:** 超买时只挂卖单，超卖时只挂买单。

### 3.2 监控与预警
- **实时状态更新:** 监控当前持仓、已实现盈亏、未实现盈亏。
- **OI 监控:** 实时监控未平仓合约量（Open Interest）变化，1h 增长 > 12% 触发熔断。
- **资金费率监控:** 实时监控 Funding Rate，超阈值停止新挂单。
- **CVD 背离检测:** 监控累计成交量差（CVD）与价格的背离情况。
- **异常处理:** 针对 API 超时、订单部分成交、余额不足等情况的重试和预警机制。
- **状态切换日志:** 记录每次从"震荡"切换到"趋势"的触发原因及所有参数快照。

### 3.3 回测系统
- 支持历史 K 线数据导入。
- 必须包含手续费模拟和滑点模拟。
- 可视化：绘制价格曲线、收益曲线及 Grid ON/OFF 的背景色标识。
- 回测需验证分级仓位响应的历史表现。

---

## 4. 风险控制 (Risk Management)

| 风险类型 | 触发条件 | 策略动作 | 优先级 |
|---------|---------|---------|--------|
| OI 激增 | 1h OI 增长 > 12% | 停止所有新挂单 | **最高** |
| 资金费率异常 | > 0.04% 或 < -0.02% | 停止新挂单 | **最高** |
| 趋势熔断 | Hurst > 0.6 且 ADX > 30 | 停止新挂单 / 收窄网格 | 高 |
| 超买保护 | 触碰 BB 2.5σ 上轨 且 Bias > 5% | 停止买入格，保留卖出格 | 中 |
| CVD 背离 | CVD 创新高但价格未创新高 | 暂停买入格 | 中 |
| 全局止损 | 资产跌破初始资金 15% | 强制清仓 | 高 |

> **注：** 风控熔断的优先级高于分级仓位响应。即使 Hurst 处于 100% 仓位区间，风控条件触发时仍立即执行保护动作。

---

## 5. 技术栈建议
- **语言:** Python 3.9+
- **核心库:**
  - `pandas`, `numpy`: 数据处理与指标计算。
  - `ccxt`: 统一对接币安及其他交易所。
  - `ta` / `pandas-ta`: 技术指标分析（ADX, ATR, BB）。
- **数据库:** `SQLite` 或 `InfluxDB`（用于记录交易流水）。
- **容器化:** `Docker` 部署，确保策略 24/7 运行。

---

## 6. 后续开发计划
1. **Phase 1:** 确定 Regime Filter 的具体计算公式并进行历史回测验证准确率。 (DONE ✅)
2. **Phase 2:** 搭建基础网格交易框架与可视化调试面板。 (DONE ✅)
3. **Phase 3:** 实现分级仓位响应 + MA200 资金分配 + ATR 动态网格区间。 (IN_PROGRESS 🔄 - 算法层已完成)
4. **Phase 4:** 实现超买保护（BB 2.5σ + Bias）+ OI/CVD 风控熔断。 (TODO 📋)
5. **Phase 5:** 集成过滤器与网格逻辑，进行小资金实盘测试。 (TODO 📋)
6. **Phase 6:** 优化性能，增加 Telegram/Discord 实时通知功能。 (TODO 📋)
