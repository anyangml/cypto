# 产品需求文档 (PRD)：Binance BTC 自适应网格交易策略 (含 Regime Filter)

**版本:** 1.0  
**状态:** 草案  
**目标:** 构建一个能够自动识别市场状态（震荡 vs 趋势），并在震荡行情中高效运行网格交易、在趋势行情中规避风险的量化系统。

---

## 1. 项目背景与目标
传统的网格交易策略在横盘震荡行情中表现优异，但在单边趋势（大涨或大跌）中极易产生大幅浮亏或卖空。本项目旨在引入 **市场状态过滤器 (Regime Filter)**，使策略能“自适应”地判断当前是否适合开启网格，从而提高夏普比率并降低最大回撤。

---

## 2. 核心算法逻辑

### 2.1 市场状态过滤器 (Regime Filter)
用于判断当前市场是 **“横盘震荡”** 还是 **“单边趋势”**。

*   **指标组合建议：**
    1.  **ADX (Average Directional Index):** 
        *   当 ADX < 20-25 时，视为弱趋势/震荡。
        *   当 ADX > 25 且在上升，视为强趋势。
    2.  **ATR (Average True Range) 波动率过滤器:**
        *   计算短期 ATR 与长期 ATR 的比值。若波动率突然激增，通常预示趋势开启。
    3.  **布林带 (Bollinger Bands) 宽度:**
        *   使用带宽 (Bandwidth) 指标。带宽收缩（Squeeze）意味着即将突破，带宽趋平且保持一定范围内则适合网格。
    4.  **Hurst 指数 (Hurst Exponent):**
        *   Hurst < 0.5：市场倾向于均值回归（适合网格）。
        *   Hurst > 0.5：市场倾向于趋势性（不适合网格）。

*   **决策逻辑：**
    *   **震荡模式 (Grid ON):** 当过滤器输出为“均值回归”且波动率处于正常区间。
    *   **趋势保护模式 (Grid PAUSE/CLOSE):** 当检测到强趋势信号（如 ADX 突破 30 且价格突破布林带上下轨）。

### 2.2 自适应网格逻辑 (Adaptive Grid)
*   **格点间距自适应:** 根据当前 ATR 自动调整网格的步长（间距）。波动率大时，增加间距以获取更大波段利润；波动率小时，收窄间距提高成交频率。
*   **网格范围动态调整:** 网格的中轴线随 EMA（指数移动平均线）动态缓慢移动，确保护网格始终覆盖当前价格区域。
*   **挂单方式:** 采用循环限价单 (Limit Orders)。一旦买单成交，立即在上方预设位置挂卖单；反之亦然。

---

## 3. 功能需求

### 3.1 交易执行模块
*   **Binance API 对接:** 支持现货 (Spot) 或 永续合约 (Futures)。
*   **资产管理:** 初始资金分配、仓位精度控制（满足币安最小交易额限制）。
*   **多级别挂单:** 支持等差数列或等比数列挂单。

### 3.2 监控与预警
*   **实时状态更新:** 监控当前持仓、已实现盈亏、未实现盈亏。
*   **异常处理:** 针对 API 超时、订单部分成交、余额不足等情况的重试和预警机制。
*   **状态切换日志:** 记录每次从“震荡”切换到“趋势”的触发原因。

### 3.3 回测系统
*   支持历史 K 线数据导入。
*   必须包含手续费模拟和滑点模拟。
*   可视化：绘制价格曲线、收益曲线及 Grid ON/OFF 的背景色标识。

---

## 4. 风险控制 (Risk Management)

1.  **全局止损 (Global Stop Loss):** 即使处于震荡状态，若价格突破网格底层且 ATR 持续放大，触发强制止损并清仓。
2.  **趋势保护机制:** 当 Regime Filter 检测到强趋势方向与持仓相反时，停止补仓逻辑。
3.  **杠杆限制 (如果使用合约):** 建议低杠杆（1-3x）或 1:1 现货交易，防止极端行情下的爆仓风险。
4.  **API 安全:** 仅开启交易权限，禁止提现权限；使用环境变量存储 API Key。

---

## 5. 技术栈建议
*   **语言:** Python 3.9+
*   **核心库:** 
    *   `pandas`, `numpy`: 数据处理与指标计算。
    *   `ccxt`: 统一对接币安及其他交易所。
    *   `pandas-ta`: 技术指标分析。
*   **数据库:** `SQLite` 或 `InfluxDB` (用于记录交易流水)。
*   **容器化:** `Docker` 部署，确保策略 24/7 运行。

---

## 6. 后续开发计划
1.  **Phase 1:** 确定 Regime Filter 的具体计算公式并进行历史回测验证准确率。
2.  **Phase 2:** 搭建基础网格交易框架，在 Testnet (币安测试网) 进行运行。
3.  **Phase 3:** 集成过滤器与网格逻辑，进行小资金实盘测试。
4.  **Phase 4:** 优化性能，增加 Telegram/Discord 实时通知功能。
