# 产品需求文档 (PRD)：Binance BTC 自适应网格交易策略 (含 Regime Filter)

**版本:** 2.1  
**更新日期:** 2026-02-19  
**状态:** 更新中  
**目标:** 构建一个能够自动识别市场状态（震荡 vs 趋势/混沌），并在震荡行情中高效运行网格交易、在趋势行情及高风险混沌状态中规避风险的量化系统。

---

## 1. 项目背景与目标
传统的网格交易策略在横盘震荡行情中表现优异，但在单边趋势（大涨或大跌）中极易产生大幅浮亏或卖空。本项目引入 **市场状态过滤器 (Regime Filter)**，使策略能"自适应"地判断当前是否适合开启网格。**v2.1 版本重点引入了针对熊市的防御机制 (Bear Defense) 和针对高频数据的双流架构 (Dual-Stream Architecture)。**

---

## 2. 核心算法逻辑

### 2.1 市场状态过滤器 (Regime Filter) — 策略总开关

用于判断当前市场是 **"横盘震荡"**、**"单边趋势"** 还是 **"混沌状态"**。

#### 指标组合

| 指标 | 计算方式 | 含义 |
|------|----------|------|
| **Hurst 指数** | R/S 分析法，窗口期 100 | H<0.5 均值回归；H>0.5 趋势持续；H>0.6 混沌高熵 |
| **ADX** | 14 周期 | 趋势强度，与方向无关 |
| **ATR 比例** | 短期 ATR(7) / 长期 ATR(28) | 波动率突变检测 |
| **BB 宽度** | 20 周期，2.0σ | 相对波动幅度 |
| **MA200 Slope** | 长期均线斜率 | 宏观趋势方向（多/空） |

#### 决策状态机

```
入场/运行条件（震荡模式 - RANGE）：
  Hurst < 0.5  AND  ADX < 25  →  Grid ON，按分级仓位运行

熔断暂停条件（趋势/混沌模式 - TREND/CHAOS）：
  Hurst > 0.60 (CHAOS)        →  高熵无序，空仓观望或半仓运行
  Trend Votes >= 3 (TREND)    →  趋势明确，停止新网格挂单

风控熔断（优先级最高）：
  OI 1h 增长 > 12%            →  立即停止新挂单
  资金费率异常                 →  停止新挂单
```

### 2.2 熊市防御机制 (Bear Defense)
针对单边下跌行情的专项优化（v2.1 新增）：
1.  **极度收敛的资金占用**: 当 Price < MA200 时，仅动用 **10%** 的总资金参与网格（原 30%）。
2.  **偏置网格 (Biased Grid)**: 空头背景下，买单资金比例自动降至 **0.1** (90% 资金用于卖单挂单或空仓)。
3.  **稀疏网格**: 网格层数从 20 降至 **10**，防止在下跌途中过密接盘。
4.  **宽容重置**: 价格偏离中轴 **5%** 才触发重置（原 3%），避免在阴跌中频繁确认亏损。

---

## 3. [NEW] 双数据流高频架构 (Dual-Stream Architecture)

针对高频（Tick/5m）交易环境下的噪音磨损和信号滞后问题，设计了 **"慢速决策 + 快速执行"** 的双流架构。

### 3.1 架构设计
*   **慢速决策流 (Strategic Stream - 1h/4h)**
    *   **数据源**: 聚合后的 1h/4h K线。
    *   **职责**: 计算 Regime Filter (Hurst/ADX/ATR)。
    *   **作用**: 决定战略方向（是否开网格、网格宽窄、多空偏置）。
    *   **优势**: 过滤高频噪音，保证策略宏观稳健，避免在 5m 级别的锯齿波中频繁止损。

*   **快速执行流 (Tactical Stream - Tick/1s)**
    *   **数据源**: 实时 Tick 或秒级数据。
    *   **职责 1 (执行)**: **事件驱动 (Event-Driven)**。一旦价格触碰网格边界（出界），**立即**触发网格重置，无需等待 1h 收线。
    *   **职责 2 (风控)**: 监控瞬时风险（如 1分钟跌 3%、OI 瞬时激增）。一旦触发，无视 1h 信号，**立即熔断**。
    *   **优势**: 消除滞后，实现毫秒级响应。

### 3.2 解决的痛点
1.  **规避噪音**: 不再回测中因 5m Hurst 的随机跳动而频繁开平仓（Over-trading）。
2.  **消除滞后**: 解决了"死板等待 1h 更新导致价格跑出网格范围"的问题。

---

## 4. 功能需求 (Updates)

### 4.1 交易执行模块
- **Binance API 对接:** 支持现货 (Spot) 或永续合约 (Futures)。
- **资产管理:** 初始资金分配、仓位精度控制。
- **多级别挂单:** 支持等差数列或等比数列挂单。
- **[NEW] 事件驱动重置:** 监听价格与网格边界关系，触发式重置。

### 4.2 监控与预警
- **实时状态更新:** 监控当前持仓、已实现盈亏。
- **OI/Funding 监控:** 实时监控风险指标。
- **[NEW] 混沌预警:** UI 增加 CHAOS 状态显示（橙色警示）。

---

## 5. 后续开发计划

1.  **Phase 1-3:** Regime Filter、网格引擎、分级仓位。 (DONE ✅)
2.  **Phase 4:** 实现超买保护（BB 2.5σ + Bias）+ OI/CVD 风控熔断。 (IN_PROGRESS 🔄)
3.  **Phase 5:** **[核心] 实现双数据流架构 (Dual-Stream)**：
    *   改造 `BacktestEngine` 支持跨周期数据对齐。
    *   实现 Event-Driven 的网格重置逻辑。
4.  **Phase 6:** 集成过滤器与网格逻辑，进行小资金实盘测试。 (TODO 📋)

